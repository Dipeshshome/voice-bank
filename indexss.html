<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyPrime Assistant - Prime Bank Limited</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #dc2626 50%, #16a34a 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 20px 0;
        }

        .container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
            max-width: 550px;
            width: 90%;
            text-align: center;
            margin: 20px auto;
        }

        .bank-header {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bank-logo {
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .bank-tagline {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
        }

        .assistant-name {
            font-size: 24px;
            font-weight: 600;
            color: #4ade80;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        .greeting-text {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }

        .voice-avatar {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: linear-gradient(45deg, #1e3a8a, #dc2626, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 55px;
            animation: prime-pulse 2s infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid rgba(255, 215, 0, 0.5);
        }

        .voice-avatar.listening {
            animation: listening 1s infinite;
            background: linear-gradient(45deg, #16a34a, #22c55e);
            transform: scale(1.1);
            border-color: #4ade80;
        }

        .voice-avatar.speaking {
            animation: speaking 0.8s infinite;
            background: linear-gradient(45deg, #dc2626, #ef4444);
            border-color: #fbbf24;
        }

        @keyframes prime-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(30, 58, 138, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 25px rgba(30, 58, 138, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(30, 58, 138, 0); }
        }

        @keyframes listening {
            0%, 100% { transform: scale(1.1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
        }

        @keyframes speaking {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.05); }
        }

        .status-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .status-display.listening {
            background: linear-gradient(45deg, rgba(34, 197, 94, 0.3), rgba(74, 222, 128, 0.3));
            border: 2px solid rgba(34, 197, 94, 0.6);
        }

        .status-display.speaking {
            background: linear-gradient(45deg, rgba(220, 38, 38, 0.3), rgba(239, 68, 68, 0.3));
            border: 2px solid rgba(220, 38, 38, 0.6);
        }

        .status-display.processing {
            background: linear-gradient(45deg, rgba(255, 193, 7, 0.3), rgba(251, 191, 36, 0.3));
            border: 2px solid rgba(255, 193, 7, 0.6);
        }

        .status-display.error {
            background: linear-gradient(45deg, rgba(239, 68, 68, 0.3), rgba(248, 113, 113, 0.3));
            border: 2px solid rgba(239, 68, 68, 0.6);
        }

        .voice-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }

        .voice-btn {
            padding: 18px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            min-width: 160px;
            border: 2px solid transparent;
        }

        .start-btn {
            background: linear-gradient(45deg, #16a34a, #22c55e);
            color: white;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .start-btn.active {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            animation: recording 1s infinite;
        }

        .stop-btn {
            background: linear-gradient(45deg, #1e3a8a, #3b82f6);
            color: white;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .stop-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        @keyframes recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .demo-banking-services {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .demo-banking-services h3 {
            margin-bottom: 20px;
            color: #ffd700;
            font-size: 18px;
            font-weight: 600;
        }

        .banking-service-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .service-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px 10px;
            font-size: 13px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .service-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            border-color: #4ade80;
        }

        .service-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .demo-qa-section {
            margin-top: 25px;
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .demo-qa-section h4 {
            color: #fbbf24;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .qa-examples {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-align: left;
            line-height: 1.5;
        }

        .qa-examples .question {
            color: #4ade80;
            font-weight: 500;
            margin-top: 8px;
        }

        .qa-examples .answer {
            color: rgba(255, 255, 255, 0.9);
            margin-left: 10px;
            margin-bottom: 8px;
        }

        .tts-selector {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tts-selector h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .tts-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tts-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            font-size: 11px;
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tts-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tts-btn.active {
            background: linear-gradient(45deg, #16a34a, #22c55e);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .volume-control {
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .volume-slider {
            width: 150px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #16a34a;
            cursor: pointer;
        }

        .footer {
            margin-top: 30px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .conversation-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
        }

        .conversation-indicator.active {
            background: linear-gradient(45deg, #16a34a, #22c55e);
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .permission-notice {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Responsive design for mobile */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
                width: 95%;
            }
            
            .voice-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .voice-btn {
                min-width: 100%;
                font-size: 16px;
            }
            
            .banking-service-buttons {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .conversation-indicator {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
    <div class="conversation-indicator" id="conversationStatus">
        🔴 কথোপকথন চলছে না
    </div>

    <div class="container">
        <div class="bank-header">
            <div class="bank-logo">🏦 Prime Bank Limited</div>
            <div class="bank-tagline">আপনার বিশ্বস্ত ব্যাংকিং পার্টনার</div>
            <div class="assistant-name">MyPrime Assistant</div>
            <div class="greeting-text">ভয়েস-ভিত্তিক স্মার্ট ব্যাংকিং সেবা</div>
        </div>

        <div class="voice-avatar" id="voiceAvatar" onclick="startCall()">
            🎙️
        </div>

        <div class="status-display" id="statusDisplay">
            <p>কল শুরু করতে মাইক্রোফোন বাটনে ক্লিক করুন</p>
        </div>

        <div class="voice-controls">
            <button class="voice-btn start-btn" id="startBtn" onclick="startCall()">
                📞 MyPrime এর সাথে কথা বলুন
            </button>
            <button class="voice-btn stop-btn hidden" id="endBtn" onclick="endCall()">
                📞 কল শেষ করুন
            </button>
        </div>

        <div id="permissionNotice" class="permission-notice hidden">
            🎙️ মাইক্রোফোন অনুমতির জন্য অপেক্ষা করুন...
        </div>

        <div class="demo-banking-services">
            <h3>🏧 Prime Bank সেবাসমূহ (ডেমো)</h3>
            <div class="banking-service-buttons">
                <button class="service-btn" onclick="handleBankingService('balance')">
                    💰 ব্যালেন্স জানুন
                </button>
                <button class="service-btn" onclick="handleBankingService('transfer')">
                    💸 ফান্ড ট্রান্সফার
                </button>
                <button class="service-btn" onclick="handleBankingService('card_block')">
                    🚫 কার্ড ব্লক করুন
                </button>
                <button class="service-btn" onclick="handleBankingService('statement')">
                    📄 স্টেটমেন্ট দেখুন
                </button>
                <button class="service-btn" onclick="handleBankingService('branch')">
                    📍 নিকটতম শাখা
                </button>
                <button class="service-btn" onclick="handleBankingService('support')">
                    📞 কাস্টমার সাপোর্ট
                </button>
            </div>
        </div>

        <div class="demo-qa-section">
            <h4>💬 ডেমো প্রশ্ন ও উত্তর উদাহরণ:</h4>
            <div class="qa-examples">
                <div class="question">প্রশ্ন: "আমার একাউন্ট ব্যালেন্স কত?"</div>
                <div class="answer">উত্তর: আপনার চেকিং একাউন্টে ৫০,০০০ টাকা এবং সেভিংস একাউন্টে ২,৫০,০০০ টাকা রয়েছে।</div>
                
                <div class="question">প্রশ্ন: "আমার কার্ড ব্লক করে দিন"</div>
                <div class="answer">উত্তর: নিরাপত্তার জন্য আপনার ডেবিট কার্ড ব্লক করা হয়েছে। নতুন কার্ডের জন্য শাখায় যোগাযোগ করুন।</div>
                
                <div class="question">প্রশ্ন: "নিকটতম এটিএম কোথায়?"</div>
                <div class="answer">উত্তর: আপনার অবস্থান থেকে সবচেয়ে কাছের Prime Bank ATM গুলশান-২ এ রয়েছে, ৫০০ মিটার দূরত্বে।</div>
            </div>
        </div>

        <div class="tts-selector">
            <h4>🔊 ভয়েস ইঞ্জিন:</h4>
            <div class="tts-buttons">
                <button class="tts-btn active" onclick="changeTTSEngine('google')">Google TTS</button>
                <button class="tts-btn" onclick="changeTTSEngine('browser')">Browser TTS</button>
            </div>
        </div>

        <div class="volume-control">
            <span>🔊</span>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80" 
                   oninput="updateVolume(this.value)">
            <span id="volumeDisplay">80%</span>
        </div>

        <div class="footer">
            <p>🏦 Prime Bank Limited - MyPrime Assistant Demo</p>
            <p style="margin-top: 5px;">Space চেপে কল শুরু করুন • Escape চেপে কল শেষ করুন</p>
            <p style="margin-top: 8px; font-size: 10px;">
                Voice Banking Demo Created by: 
                <a href="https://www.linkedin.com/in/dipesh-shome-575854113/" target="_blank" style="color: #ffd700; font-weight: 500;">
                  Dipesh Shome
                </a>
            </p>
        </div>
    </div>

    <script>
        let isListening = false;
        let callActive = false;
        let recognition;
        let synthesis = window.speechSynthesis;
        let currentTTSEngine = 'google';
        let currentVolume = 0.8;
        let conversationTurn = 'user';
        let silenceTimer;
        let autoListenDelay = 2000;
        let microphonePermissionGranted = false;
        let recognitionInitialized = false;
        let verificationStage = 'none'; // 'none', 'asking_digits', 'asking_father_name', 'verified'
        let userQuery = '';
        let verificationData = {
            cardDigits: '',
            fatherName: ''
        };

        // Prime Bank Bengali responses database
        const primeBankResponses = {
            balance: "আসসালামু আলাইকুম। আপনার একাউন্ট ব্যালেন্স জানার জন্য নিরাপত্তার খাতিরে আপনার একাউন্ট নম্বরের শেষ চার ডিজিট এবং আপনার মাতার নাম বলুন। অথবা আপনার PIN নম্বর দিন।",
            
            transfer: "Prime Bank ফান্ড ট্রান্সফার সেবায় স্বাগতম। আপনি কোথায় টাকা পাঠাতে চান? অন্য Prime Bank একাউন্টে, নাকি অন্য ব্যাংকে? এবং কত টাকা ট্রান্সফার করতে চান?",
            
            card_block: "জরুরি কার্ড ব্লকের জন্য আমি এখনই সাহায্য করছি। আপনার ডেবিট কার্ড নাকি ক্রেডিট কার্ড ব্লক করতে চান? নিরাপত্তার জন্য আপনার কার্ড নম্বরের শেষ চার ডিজিট বলুন।",
            
            statement: "Prime Bank স্টেটমেন্ট সেবায় আপনাকে স্বাগতম। আপনি গত ৩০ দিনের লেনদেন দেখতে চান নাকি নির্দিষ্ট সময়ের? আপনার ইমেইলে পাঠানো হবে নাকি SMS এ সংক্ষিপ্ত তথ্য চান?",
            
            branch: "Prime Bank এর নিকটতম শাখা এবং ATM খুঁজে দিচ্ছি। আপনি কোন এলাকায় আছেন? ঢাকার কোন এলাকায় শাখা বা ATM খুঁজছেন? আমাদের গুলশান, ধানমন্ডি, মতিঝিল সব জায়গায় শাখা আছে।",
            
            support: "Prime Bank কাস্টমার সাপোর্টে যোগাযোগ করাচ্ছি। আপনার সমস্যাটি কী? লোন সংক্রান্ত, কার্ড সমস্যা, নাকি একাউন্ট সংক্রান্ত? আমি এখানেই সাহায্য করতে পারি অথবা বিশেষজ্ঞ অফিসারের সাথে যোগাযোগ করিয়ে দিতে পারি।",
            
            greeting: [
                "আসসালামু আলাইকুম! আমি MyPrime Assistant। Prime Bank এর ভয়েস ব্যাংকিং সেবায় আপনাকে স্বাগতম। আজ কীভাবে সাহায্য করতে পারি? আপনি ব্যালেন্স চেক, ফান্ড ট্রান্সফার, কার্ড সেবা, বা অন্য কোনো সাহায্য চান?",
                "আসসালামু আলাইকুম! Prime Bank এর পক্ষ থেকে MyPrime Assistant বলছি। আপনার ব্যাংকিং প্রয়োজনে আমি এখানে আছি। আপনি কোন সেবা নিতে চান - ব্যালেন্স জানতে, টাকা ট্রান্সফার করতে, নাকি কার্ড সংক্রান্ত কোনো সাহায্য?",
                "আসসালামু আলাইকুম! MyPrime Assistant এ আপনাকে স্বাগতম। Prime Bank এর সব সেবা এখন আপনার কণ্ঠস্বরেই। বলুন আপনার কী প্রয়োজন - একাউন্ট তথ্য, কার্ড সেবা, নাকি অন্য কিছু?"
            ],
            
            verification: {
                askDigits: "নিরাপত্তার জন্য প্রথমে আপনার পরিচয় যাচাই করতে হবে। আপনার ডেবিট কার্ড বা ক্রেডিট কার্ডের শেষ চার ডিজিট বলুন।",
                askFatherName: "ধন্যবাদ। এখন আপনার পিতার নাম বলুন।",
                verified: "যাচাইকরণ সম্পন্ন হয়েছে। এখন আমি আপনার সেবা করতে পারি।",
                failed: "দুঃখিত, যাচাইকরণ সম্পন্ন হয়নি। নিরাপত্তার জন্য আবার চেষ্টা করুন অথবা নিকটতম Prime Bank শাখায় যোগাযোগ করুন।"
            },
            
            loan_info: "Prime Bank বিভিন্ন ধরনের লোন দিয়ে থাকে। হোম লোন, কার লোন, পার্সোনাল লোন, ব্যবসায়িক লোন। সুদের হার ৮% থেকে ১৫% পর্যন্ত। কোন ধরনের লোন নিয়ে জানতে চান?",
            
            default: "দুঃখিত, আপনার কথা স্পষ্ট বুঝতে পারলাম না। আপনি বলতে পারেন - ব্যালেন্স চেক, ফান্ড ট্রান্সফার, কার্ড ব্লক, স্টেটমেন্ট, শাখার তথ্য, অথবা কাস্টমার সাপোর্ট। আবার বলুন কী সাহায্য লাগবে?"
        };

        // Demo account information for realistic responses
        const demoAccountInfo = {
            balance: {
                checking: "৫০,০০০",
                savings: "২,৫০,০০০"
            },
            lastTransactions: [
                "বেফিক্র পেমেন্ট -৫০০ টাকা",
                "ATM উত্তোলন -২,০০০ টাকা", 
                "স্যালারি ক্রেডিট +৪৫,০০০ টাকা"
            ],
            nearestBranch: "গুলশান-২ শাখা, ৫০০ মিটার দূরত্বে",
            customerService: "১৬২৪৭ অথবা ৮৮০-১৯১০-১৬২৪৭"
        };

        // Initialize speech recognition
        async function initializeSpeechRecognition() {
            if (recognitionInitialized) {
                return true;
            }

            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                updateStatus("দুঃখিত, আপনার ব্রাউজার ভয়েস রিকগনিশন সাপোর্ট করে না।", "error");
                return false;
            }

            try {
                showPermissionNotice(true);
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                microphonePermissionGranted = true;
                showPermissionNotice(false);
                
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'bn-BD';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    console.log('Speech recognition started');
                    isListening = true;
                    updateStatus("আপনার কথা শুনছি... স্পষ্ট করে বলুন", "listening");
                    updateUI("listening");
                    updateConversationStatus(true);
                };

                recognition.onresult = function(event) {
                    console.log('Speech recognition result:', event.results[0][0].transcript);
                    const transcript = event.results[0][0].transcript;
                    
                    isListening = false;
                    conversationTurn = 'ai';
                    updateStatus("আপনার কথা বুঝে উত্তর দিচ্ছি...", "processing");
                    processVoiceInput(transcript);
                };

                recognition.onerror = function(event) {
                    console.log('Recognition error:', event.error);
                    isListening = false;
                    
                    if (event.error === 'not-allowed') {
                        updateStatus("মাইক্রোফোন অনুমতি প্রয়োজন। অনুগ্রহ করে অনুমতি দিন।", "error");
                        microphonePermissionGranted = false;
                        showPermissionNotice(false);
                        endCall();
                        return;
                    }
                    
                    if (callActive) {
                        updateStatus("দুঃখিত, আপনার কথা পরিষ্কার শুনতে পেলাম না। আবার বলুন।", "error");
                        
                        if (event.error !== 'no-speech') {
                            speakResponse("দুঃখিত, আপনার কথা পরিষ্কার শুনতে পেলাম না। আবার বলুন।");
                        } else {
                            setTimeout(() => {
                                if (callActive && !isListening) {
                                    startListening();
                                }
                            }, 2000);
                        }
                    }
                };

                recognition.onend = function() {
                    isListening = false;
                    if (callActive && conversationTurn === 'user') {
                        setTimeout(() => {
                            if (callActive && !isListening) {
                                startListening();
                            }
                        }, 1000);
                    }
                };

                recognitionInitialized = true;
                return true;
                
            } catch (error) {
                console.error('Microphone permission error:', error);
                showPermissionNotice(false);
                
                if (error.name === 'NotAllowedError') {
                    updateStatus("মাইক্রোফোন অনুমতি দেওয়া হয়নি। কল শুরু করতে মাইক্রোফোন অনুমতি প্রয়োজন।", "error");
                } else {
                    updateStatus("মাইক্রোফোন অ্যাক্সেস করতে সমস্যা হয়েছে। আবার চেষ্টা করুন।", "error");
                }
                
                microphonePermissionGranted = false;
                return false;
            }
        }

        function showPermissionNotice(show) {
            const notice = document.getElementById('permissionNotice');
            if (show) {
                notice.classList.remove('hidden');
            } else {
                notice.classList.add('hidden');
            }
        }

        async function startCall() {
            const initialized = await initializeSpeechRecognition();
            
            if (!initialized || !microphonePermissionGranted) {
                return;
            }

            callActive = true;
            isListening = false;
            conversationTurn = 'ai';
            
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('endBtn').classList.remove('hidden');
            document.querySelector('.voice-avatar').onclick = toggleListening;
            
            document.querySelectorAll('.service-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
            
            updateStatus("Prime Bank এ স্বাগতম... MyPrime Assistant সংযোগ করা হচ্ছে", "processing");
            updateConversationStatus(true);
            
            setTimeout(() => {
                const greeting = primeBankResponses.greeting[Math.floor(Math.random() * primeBankResponses.greeting.length)];
                speakResponse(greeting + " এখন আপনি আমার সাথে সরাসরি কথা বলতে পারেন।", true);
            }, 1500);
        }

        function endCall() {
            callActive = false;
            isListening = false;
            conversationTurn = 'user';
            
            // Reset verification state
            verificationStage = 'none';
            userQuery = '';
            verificationData = {
                cardDigits: '',
                fatherName: ''
            };
            
            if (recognition) {
                recognition.stop();
            }
            
            if (synthesis) {
                synthesis.cancel();
            }
            
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('endBtn').classList.add('hidden');
            document.querySelector('.voice-avatar').onclick = startCall;
            
            document.querySelectorAll('.service-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            
            updateStatus("কল শেষ হয়েছে। Prime Bank এর সেবা নিতে আবার কল করুন।", "ready");
            updateConversationStatus(false);
            resetUI();
            
            speakResponse("Prime Bank এর সেবা নেওয়ার জন্য ধন্যবাদ। আসসালামু আলাইকুম।");
        }

        function toggleListening() {
            if (!callActive) {
                startCall();
                return;
            }
            
            if (callActive && !isListening && conversationTurn === 'user') {
                startListening();
            }
        }

        function startListening() {
            if (recognition && callActive && !isListening && microphonePermissionGranted) {
                try {
                    isListening = true;
                    conversationTurn = 'user';
                    recognition.start();
                    updateConversationStatus(true);
                } catch (error) {
                    console.log('Failed to start recognition:', error);
                    isListening = false;
                    setTimeout(() => {
                        if (callActive && !isListening) {
                            startListening();
                        }
                    }, 1000);
                }
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                try {
                    recognition.stop();
                    isListening = false;
                } catch (error) {
                    console.log('Error stopping recognition:', error);
                    isListening = false;
                }
            }
        }

        function resetUI() {
            const avatar = document.getElementById('voiceAvatar');
            
            avatar.className = 'voice-avatar';
            
            if (callActive) {
                avatar.innerHTML = '📞';
                
                if (conversationTurn === 'user' && !isListening) {
                    updateStatus("আপনার পালা... কথা বলুন", "ready");
                    setTimeout(() => {
                        if (callActive && !isListening && conversationTurn === 'user') {
                            startListening();
                        }
                    }, autoListenDelay);
                }
            } else {
                avatar.innerHTML = '🎙️';
                updateStatus("MyPrime Assistant এর সাথে কথা বলতে ক্লিক করুন", "ready");
            }
        }

        function updateUI(state) {
            const avatar = document.getElementById('voiceAvatar');

            avatar.className = 'voice-avatar';

            switch(state) {
                case 'listening':
                    avatar.classList.add('listening');
                    avatar.innerHTML = '🎧';
                    if (callActive) {
                        updateStatus("শুনছি... বলুন", "listening");
                    }
                    break;
                case 'speaking':
                    avatar.classList.add('speaking');
                    avatar.innerHTML = '🔊';
                    break;
                case 'processing':
                    avatar.innerHTML = '🤔';
                    break;
                default:
                    if (callActive) {
                        avatar.innerHTML = '📞';
                    } else {
                        avatar.innerHTML = '🎙️';
                    }
            }
        }

        function updateStatus(message, type) {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.innerHTML = `<p>${message}</p>`;
            
            statusDisplay.className = 'status-display';
            if (type) {
                statusDisplay.classList.add(type);
            }
        }

        function updateConversationStatus(active) {
            const indicator = document.getElementById('conversationStatus');
            if (callActive) {
                if (isListening) {
                    indicator.innerHTML = '🎙️ আপনার কথা শুনছি';
                } else if (conversationTurn === 'ai') {
                    indicator.innerHTML = '🤖 MyPrime উত্তর দিচ্ছে';
                } else {
                    indicator.innerHTML = '📞 Prime Bank কল চলছে';
                }
                indicator.classList.add('active');
            } else {
                indicator.innerHTML = '🔴 কল বন্ধ';
                indicator.classList.remove('active');
            }
        }

        function processVoiceInput(input) {
            console.log('Processing input:', input, 'Verification stage:', verificationStage);
            
            // Handle verification process
            if (verificationStage === 'asking_digits') {
                handleDigitsVerification(input);
                return;
            }
            
            if (verificationStage === 'asking_father_name') {
                handleFatherNameVerification(input);
                return;
            }
            
            // Check if this is a banking query that needs verification
            if (verificationStage === 'none' && requiresVerification(input)) {
                userQuery = input;
                startVerificationProcess();
                return;
            }
            
            // Process verified queries or general queries
            const response = generatePrimeBankResponse(input);
            speakResponse(response);
        }

        function requiresVerification(input) {
            const lowerInput = input.toLowerCase();
            const bankingKeywords = [
                'ব্যালেন্স', 'টাকা', 'balance', 'কার্ড', 'ট্রান্সফার', 'transfer', 
                'স্টেটমেন্ট', 'statement', 'লেনদেন', 'একাউন্ট', 'account', 'পাঠাতে', 
                'উত্তোলন', 'জমা', 'ব্লক', 'পিন', 'pin'
            ];
            
            return bankingKeywords.some(keyword => lowerInput.includes(keyword));
        }

        function startVerificationProcess() {
            verificationStage = 'asking_digits';
            speakResponse(primeBankResponses.verification.askDigits);
        }

        function handleDigitsVerification(input) {
            // Extract digits from input
            const digits = input.replace(/[^\d]/g, '');
            
            if (digits.length >= 4) {
                verificationData.cardDigits = digits.slice(-4);
                verificationStage = 'asking_father_name';
                speakResponse(primeBankResponses.verification.askFatherName);
            } else {
                speakResponse("দুঃখিত, আমি চার ডিজিট পরিষ্কার শুনতে পেলাম না। আবার বলুন আপনার কার্ডের শেষ চার ডিজিট।");
            }
        }

        function handleFatherNameVerification(input) {
            if (input.trim().length > 2) {
                verificationData.fatherName = input.trim();
                verificationStage = 'verified';
                
                // Process the original query after verification
                const verifiedResponse = primeBankResponses.verification.verified + " " + generatePrimeBankResponse(userQuery);
                speakResponse(verifiedResponse);
                
                // Reset for next query (but keep user verified for this session)
                userQuery = '';
            } else {
                speakResponse("দুঃখিত, আপনার পিতার নাম পরিষ্কার শুনতে পেলাম না। আবার বলুন।");
            }
        }

        function generatePrimeBankResponse(input) {
            const lowerInput = input.toLowerCase();
            
            // If user is not verified and asking banking query, redirect to verification
            if (verificationStage === 'none' && requiresVerification(input)) {
                userQuery = input;
                startVerificationProcess();
                return;
            }
            
            // Balance inquiry responses (only after verification)
            if (verificationStage === 'verified' && (lowerInput.includes('ব্যালেন্স') || lowerInput.includes('টাকা কত') || lowerInput.includes('balance'))) {
                return `আপনার চেকিং একাউন্টে ${demoAccountInfo.balance.checking} টাকা এবং সেভিংস একাউন্টে ${demoAccountInfo.balance.savings} টাকা রয়েছে। সর্বশেষ লেনদেন: ${demoAccountInfo.lastTransactions[0]}। আর কিছু জানতে চান?`;
            }
            
            // Card blocking responses (only after verification)
            if (verificationStage === 'verified' && lowerInput.includes('কার্ড') && (lowerInput.includes('ব্লক') || lowerInput.includes('বন্ধ') || lowerInput.includes('হারিয়ে'))) {
                return `নিরাপত্তার জন্য আপনার ডেবিট কার্ড তৎক্ষণাৎ ব্লক করা হয়েছে। নতুন কার্ডের জন্য আগামীকাল যেকোনো Prime Bank শাখায় যোগাযোগ করুন। রেফারেন্স নম্বর: PB${Math.floor(Math.random() * 100000)}। আর কোনো সাহায্য লাগবে?`;
            }
            
            // Fund transfer responses (only after verification)
            if (verificationStage === 'verified' && (lowerInput.includes('ট্রান্সফার') || lowerInput.includes('পাঠাতে') || lowerInput.includes('পাঠান') || lowerInput.includes('transfer'))) {
                return primeBankResponses.transfer + " এছাড়াও bKash, Nagad এ সরাসরি পাঠাতে পারবেন Prime Bank অ্যাপ দিয়ে।";
            }
            
            // Statement responses (only after verification)
            if (verificationStage === 'verified' && (lowerInput.includes('স্টেটমেন্ট') || lowerInput.includes('লেনদেন') || lowerInput.includes('statement'))) {
                return `আপনার সর্বশেষ ৩টি লেনদেন: ১) ${demoAccountInfo.lastTransactions[0]}, ২) ${demoAccountInfo.lastTransactions[1]}, ৩) ${demoAccountInfo.lastTransactions[2]}। বিস্তারিত স্টেটমেন্ট আপনার ইমেইলে পাঠানো হবে।`;
            }
            
            // General information (no verification needed)
            // Branch/ATM location responses
            if (lowerInput.includes('শাখা') || lowerInput.includes('atm') || lowerInput.includes('নিকটতম') || lowerInput.includes('branch')) {
                return `আপনার ${demoAccountInfo.nearestBranch} অবস্থিত। শাখার সময়: সকাল ৯টা থেকে বিকাল ৪টা। ATM সেবা ২৪ ঘন্টা। প্রয়োজনে Google Maps এ Prime Bank লিখে সার্চ করুন।`;
            }
            
            // Customer support responses
            if (lowerInput.includes('সাপোর্ট') || lowerInput.includes('সাহায্য') || lowerInput.includes('support') || lowerInput.includes('হটলাইন')) {
                return `Prime Bank কাস্টমার সাপোর্ট হটলাইন: ${demoAccountInfo.customerService}। ২৪ ঘন্টা সেবা। অথবা Prime Bank অ্যাপে Live Chat করতে পারেন। আমি এখানেই আছি আরো সাহায্যের জন্য।`;
            }
            
            // Loan information
            if (lowerInput.includes('লোন') || lowerInput.includes('ঋণ') || lowerInput.includes('loan')) {
                return primeBankResponses.loan_info + " এখনই অ্যাপ্লাই করতে চাইলে Prime Bank অ্যাপ ব্যবহার করুন।";
            }
            
            // Greeting responses
            if (lowerInput.includes('হ্যালো') || lowerInput.includes('নমস্কার') || lowerInput.includes('আসসালামু')) {
                return "আসসালামু আলাইকুম! Prime Bank এ আপনাকে স্বাগতম। MyPrime Assistant হিসেবে আমি আপনার সব ব্যাংকিং প্রয়োজনে সাহায্য করতে এখানে আছি। কী সেবা লাগবে?";
            }
            
            // Default response
            return primeBankResponses.default + " Prime Bank অ্যাপ ডাউনলোড করে আরো সুবিধা পেতে পারেন।";
        }

        function handleBankingService(service) {
            if (callActive) {
                speakResponse("কল চলাকালীন সময়ে আপনি সরাসরি কথা বলে সেবা নিতে পারেন।");
                return;
            }
            
            let response = '';
            switch(service) {
                case 'balance':
                    response = "ব্যালেন্স জানার জন্য প্রথমে আপনার পরিচয় যাচাই করতে হবে। " + primeBankResponses.verification.askDigits;
                    break;
                case 'transfer':
                    response = "ফান্ড ট্রান্সফারের জন্য প্রথমে আপনার পরিচয় যাচাই করতে হবে। " + primeBankResponses.verification.askDigits;
                    break;
                case 'card_block':
                    response = "কার্ড ব্লকের জন্য প্রথমে আপনার পরিচয় যাচাই করতে হবে। " + primeBankResponses.verification.askDigits;
                    break;
                case 'statement':
                    response = "স্টেটমেন্টের জন্য প্রথমে আপনার পরিচয় যাচাই করতে হবে। " + primeBankResponses.verification.askDigits;
                    break;
                case 'branch':
                    response = primeBankResponses.branch;
                    break;
                case 'support':
                    response = primeBankResponses.support;
                    break;
            }
            
            updateStatus("Prime Bank সেবা নির্বাচিত হয়েছে", "processing");
            speakResponse(response);
        }

        async function speakResponse(text, startCall = false) {
            updateUI("speaking");
            conversationTurn = 'ai';
            updateStatus("🔊 MyPrime Assistant উত্তর দিচ্ছে...", "speaking");
            updateConversationStatus(false);
            
            try {
                if (currentTTSEngine === 'google') {
                    await speakWithGoogleTTS(text);
                } else {
                    speakWithBrowserTTS(text);
                }
            } catch (error) {
                console.error('TTS Error:', error);
                speakWithBrowserTTS(text);
            }
            
            setTimeout(() => {
                if (callActive) {
                    conversationTurn = 'user';
                    resetUI();
                } else {
                    resetUI();
                }
                
                if (startCall && callActive) {
                    setTimeout(() => {
                        if (callActive) {
                            startListening();
                        }
                    }, 1000);
                }
            }, 1000);
        }

        async function speakWithGoogleTTS(text) {
            try {
                const encodedText = encodeURIComponent(text);
                const audioUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=bn&client=tw-ob&ttsspeed=0.8`;
                
                const audio = new Audio();
                audio.volume = currentVolume;
                
                return new Promise((resolve, reject) => {
                    audio.onloadeddata = () => {
                        audio.play().then(resolve).catch(reject);
                    };
                    audio.onerror = () => {
                        console.log('Google TTS failed, using browser TTS');
                        speakWithBrowserTTS(text);
                        resolve();
                    };
                    audio.src = audioUrl;
                });
            } catch (error) {
                speakWithBrowserTTS(text);
            }
        }

        function speakWithBrowserTTS(text) {
            if (synthesis) {
                synthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'bn-BD';
                utterance.rate = 0.8;
                utterance.pitch = 1.1;
                utterance.volume = currentVolume;
                
                synthesis.speak(utterance);
            }
        }

        function changeTTSEngine(engine) {
            currentTTSEngine = engine;
            
            document.querySelectorAll('.tts-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const engineName = engine === 'google' ? 'গুগল টিটিএস' : 'ব্রাউজার টিটিএস';
            speakResponse(`ভয়েস ইঞ্জিন পরিবর্তন করা হয়েছে ${engineName} এ`);
        }

        function updateVolume(value) {
            currentVolume = value / 100;
            document.getElementById('volumeDisplay').textContent = value + '%';
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateStatus("MyPrime Assistant এর সাথে কথা বলতে প্রস্তুত", "ready");
        });

        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && !callActive) {
                event.preventDefault();
                startCall();
            } else if (event.code === 'Space' && callActive && !isListening && conversationTurn === 'user') {
                event.preventDefault();
                startListening();
            } else if (event.code === 'Escape' && callActive) {
                endCall();
            }
        });

        window.addEventListener('beforeunload', function(event) {
            if (callActive) {
                event.preventDefault();
                event.returnValue = 'Prime Bank কল চলছে। পেজ ছেড়ে যেতে চান?';
            }
        });
    </script>
</body>
</html>